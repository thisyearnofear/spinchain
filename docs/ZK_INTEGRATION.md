# ZK Integration Guide

Complete guide for integrating Zero-Knowledge proofs into SpinChain.

---

## Overview

SpinChain uses **Noir** (Aztec's ZK language) to prove fitness effort without revealing sensitive health data. This guide covers circuit development, deployment, and usage.

---

## Quick Start

### Prerequisites
```bash
# Install Noir
curl -L https://noirup.dev | bash
noirup

# Verify installation
nargo --version
```

### Compile Circuits
```bash
cd circuits/effort_threshold

# Compile
nargo compile

# Run tests
nargo test

# Generate verifier contract
nargo codegen-verifier
```

---

## Circuit Details

### `effort_threshold`

Proves that a rider maintained their heart rate above a threshold for a minimum duration.

**Private Inputs:**
```rust
heart_rates: [u16; 60],  // 60 seconds of HR data
num_points: u32,          // Actual data points used
```

**Public Inputs:**
```rust
threshold: u16,      // Target HR (e.g., 150)
min_duration: u32,   // Minimum seconds required
```

**Outputs:**
```rust
threshold_met: bool,    // Did they meet the goal?
seconds_above: u32,     // How many seconds above threshold
effort_score: u16,      // 0-1000 calculated score
```

### Algorithm
```rust
for each heart_rate in heart_rates:
    if heart_rate > threshold:
        seconds_above += 1
        
threshold_met = seconds_above >= min_duration

// Effort score = (avg_effort / threshold) * 500
effort_score = min(1000, (avg_hr / threshold) * 500)
```

---

## Deployment

### 1. Generate Verifier Contract

```bash
cd circuits/effort_threshold
nargo codegen-verifier

# Output: contract/effort_threshold/plonk_vk.sol
```

### 2. Deploy to Avalanche

```solidity
// Deploy UltraVerifier (generated by Noir)
UltraVerifier ultraVerifier = new UltraVerifier();

// Deploy SpinChain verifier
EffortThresholdVerifier verifier = new EffortThresholdVerifier(
    address(ultraVerifier)
);
```

### 3. Update Environment

```bash
# .env.local
NEXT_PUBLIC_EFFORT_VERIFIER_ADDRESS=0x...
```

---

## TypeScript Usage

### Generate Proof

```typescript
import { useZKClaim } from '@/app/hooks/use-zk-claim';

function ClaimButton() {
  const { generateProof, submitProof, isGeneratingProof } = useZKClaim();
  
  const handleClaim = async () => {
    // Step 1: Generate ZK proof
    const proofResult = await generateProof(
      165,    // max heart rate achieved
      150,    // threshold
      10      // duration in minutes
    );
    
    if (!proofResult.success) {
      console.error(proofResult.error);
      return;
    }
    
    // Step 2: Submit to verifier
    await submitProof(
      {
        spinClass: '0x...',
        rider: '0x...',
        rewardAmount: '10',
        classId: '0x...',
      },
      proofResult.proof
    );
  };
  
  return (
    <button onClick={handleClaim} disabled={isGeneratingProof}>
      {isGeneratingProof ? 'Generating Proof...' : 'Claim Rewards'}
    </button>
  );
}
```

### Check Privacy Score

```typescript
const { privacyScore, privacyLevel } = useZKClaim();

// privacyScore: 0-100
// privacyLevel: 'high' | 'medium' | 'low'

return (
  <div>
    Privacy: {privacyLevel} ({privacyScore}/100)
    {privacyLevel === 'high' && 'ðŸ”’ Minimal data revealed'}
  </div>
);
```

---

## Selective Disclosure

### Create Custom Disclosure

```typescript
import { DisclosureBuilder, DEFAULT_POLICY } from '@/app/lib/zk/disclosure';

const disclosure = new DisclosureBuilder(DEFAULT_POLICY)
  .withProof(proof)
  .withStatement('Completed 30-minute endurance zone')
  .withMetadata({ duration: 30, zone: 'Endurance' })
  .build();

console.log(disclosure.statement);
// "Completed 30-minute endurance zone"

console.log(disclosure.revealed);
// { effortScore: 750, zone: 'Target', duration: 30 }

console.log(disclosure.hidden);
// { maxHeartRate: 0, avgPower: 0, rawDataPoints: 0 }
```

### Privacy Policies

```typescript
// High privacy (default)
const HIGH_PRIVACY = {
  privateFields: ['heartRate', 'power', 'cadence', 'gps', 'biometrics'],
  revealableFields: ['effortScore', 'zone'],
  publicFields: ['classId', 'riderId', 'timestamp'],
};

// Medium privacy (competitions)
const MEDIUM_PRIVACY = {
  privateFields: ['heartRate', 'gps', 'biometrics'],
  revealableFields: ['effortScore', 'zone', 'duration', 'ranking'],
  publicFields: ['classId', 'riderId', 'timestamp'],
};
```

---

## Local Oracle

### Session-Based Proving

```typescript
import { useLocalOracle } from '@/app/lib/zk/oracle';

function RideSession() {
  const { oracle, startSession, addTelemetry, endSession } = useLocalOracle();
  
  // Start ride
  const startRide = () => {
    startSession({
      classId: 'class-123',
      riderId: 'rider-456',
      startTime: Date.now(),
      targetHeartRate: 150,
      minDuration: 600, // 10 minutes
    });
  };
  
  // Add sensor data (called from WebSocket/Bluetooth)
  const onHeartRate = (hr: number) => {
    addTelemetry({
      timestamp: Date.now(),
      heartRate: hr,
      power: 200,
      cadence: 80,
    });
  };
  
  // End ride and generate proof
  const finishRide = async () => {
    const result = await endSession();
    
    if (result.success) {
      console.log('Proof generated:', result.proof);
      console.log('Effort score:', result.disclosure?.revealed.effortScore);
    }
  };
}
```

---

## Testing

### Mock Prover (Development)

```typescript
import { getProver } from '@/app/lib/zk/prover';

const prover = getProver();
prover.setUseNoir(false); // Force mock

const proof = await prover.proveEffortThreshold(165, 150, 'class', 'rider', 10);
const valid = await prover.verify(proof);
// valid === true
```

### Noir Prover (Production)

```typescript
// Install packages
npm install @noir-lang/backend_barretenberg @noir-lang/noir_js

// Prover auto-detects Noir availability
const prover = getProver();
console.log(prover.getBackendInfo());
// { type: 'noir', available: true }
```

---

## Troubleshooting

### "Circuit not found"
- Ensure `circuits/effort_threshold/target/` exists
- Run `nargo compile` to generate

### "Noir packages not installed"
- Install: `npm install @noir-lang/backend_barretenberg @noir-lang/noir_js`
- Or use mock prover for development

### "Proof verification failed"
- Check `NEXT_PUBLIC_EFFORT_VERIFIER_ADDRESS` is set
- Ensure verifier contract is deployed to correct network
- Verify proof hasn't been used before (replay protection)

### "Gas estimation failed"
- ZK verification is gas-intensive (~200k gas)
- Ensure rider has sufficient AVAX

---

## Advanced Topics

### Custom Circuits

To add a new circuit:

1. Create `circuits/my_circuit/`
2. Write `src/main.nr`
3. Add tests
4. Generate verifier
5. Deploy contract
6. Update `lib/zk/types.ts` with new CircuitType

### Batch Verification

```solidity
// Verify multiple proofs in one transaction
bytes[] memory proofs = [proof1, proof2, proof3];
bytes32[][] memory inputs = [inputs1, inputs2, inputs3];

uint16[] memory scores = verifier.batchVerify(proofs, inputs);
```

### Circuit Upgrades

1. Deploy new `UltraVerifier` contract
2. Update `EffortThresholdVerifier` to point to new verifier
3. Old proofs still valid (stored in `usedProofs`)

---

## Resources

- [Noir Documentation](https://noir-lang.org/)
- [UltraPlonk Paper](https://eprint.iacr.org/2022/1355)
- [Aztec Network](https://aztec.network/)
- [SpinChain Circuits](../circuits/)
